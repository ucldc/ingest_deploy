---
# tasks file for blackstar
- name: include vaulted passwords
  include_vars: ./roles/common/vars/all_secrets.yml
- name: get correct urls for environment
  include_vars:  "./roles/worker/vars/main{{ name_suffix }}.yml"
- name: get vaulted passwords & URLs for environment
  include_vars:  "./roles/worker/vars/vaulted.yml"
- name: get environment specific
  include_vars: "./group_vars/{{ data_branch }}"
- name: put profile in place, to unset PYTHON_INSTALL_LAYOUT
  copy:
    src: .bash_profile
    dest: "/home/{{ role_user }}/.bash_profile"
- name: put .ansible.cfg to point to local hosts file
  template:
    src: ansible.cfg.j2
    dest: "/home/{{ role_user }}/.ansible.cfg"
- name: put harvester environment vars file in place
  template:
    src: ./roles/worker/templates/harvester-env.j2
    dest: "/home/{{ role_user }}/.harvester-env"
- name: set .ssh dir
  file:
    state: directory
    mode: 0700
    dest: ~/.ssh
- name: put ingest-private.pem in place
  template:
    src: ingest-private.pem.j2
    dest: "/home/{{ role_user }}/.ssh/ingest-private.pem"
    mode: 0400
- name: put ssh config in place
  template:
    src: ssh_config
    dest: "/home/{{ role_user }}/.ssh/config"
    mode: 0400
- name: put ansible hosts file in place for data_branch
  template:
    src: hosts.j2
    dest: "/home/{{ role_user }}/hosts"
- name: install ansible
  pip:
    name: ansible
    state: present
    virtualenv: "/home/{{ role_user }}/python2"
- name: grab harvester code for install
  git:
    repo: https://github.com/ucldc/harvester
    dest: "/home/{{ role_user}}/tmp/harvester"
- name: install harvester code
  shell: /home/{{ role_user }}/python2/bin/python setup.py install
  args:
    chdir: "/home/{{ role_user}}/tmp/harvester"
- name: remove harvester repo
  file:
    path: "/home/{{ role_user}}/tmp"
    state: absent
- name: make user ~/bin directory
  file:
    path: "/home/{{ role_user }}/bin"
    state: directory
